name: SEO Post-Deploy Index Check

on:
  push:
    branches:
      - main
    paths:
      - data/seo-generated-posts.json

permissions:
  contents: read

jobs:
  index_check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Verify new URLs appear in sitemap, then ping Google
        shell: bash
        run: |
          set -euo pipefail

          node <<'NODE'
          const fs = require('fs');
          const { execSync } = require('child_process');

          function readJsonAt(ref, file) {
            try {
              return JSON.parse(execSync(`git show ${ref}:${file}`, { encoding: 'utf8' }));
            } catch {
              return [];
            }
          }

          const file = 'data/seo-generated-posts.json';
          const curr = readJsonAt('HEAD', file);
          const prev = readJsonAt('HEAD^', file);
          const prevSlugs = new Set(prev.map((p) => p.slug).filter(Boolean));
          const added = curr.filter((p) => p?.slug && !prevSlugs.has(p.slug));
          const urls = added.map((p) => `https://traingpt.co/blog/${p.slug}`);

          fs.writeFileSync('new-urls.txt', urls.join('\n') + (urls.length ? '\n' : ''));
          console.log(`Detected ${urls.length} new URL(s).`);
          NODE

          if [ ! -s new-urls.txt ]; then
            echo "No new URLs detected; nothing to verify."
            exit 0
          fi

          SITEMAP_URL="https://traingpt.co/sitemap.xml"

          for attempt in $(seq 1 15); do
            echo "Attempt $attempt: checking sitemap..."
            SITEMAP_CONTENT=$(curl -fsSL "$SITEMAP_URL")

            missing=0
            while IFS= read -r url; do
              [ -z "$url" ] && continue
              if ! printf '%s' "$SITEMAP_CONTENT" | grep -Fq "$url"; then
                echo "Missing: $url"
                missing=$((missing + 1))
              fi
            done < new-urls.txt

            if [ "$missing" -eq 0 ]; then
              echo "All new URLs found in sitemap."
              break
            fi

            if [ "$attempt" -eq 15 ]; then
              echo "Sitemap did not include all new URLs within retry window."
              exit 1
            fi

            sleep 60
          done

          curl -fsSL "https://www.google.com/ping?sitemap=https%3A%2F%2Ftraingpt.co%2Fsitemap.xml" >/dev/null
          echo "Sitemap ping sent."
